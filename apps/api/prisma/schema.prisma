generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        Int      @id @default(autoincrement())
  address   String   @unique
  username  String?
  ensName   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sessions Session[]
}

model Session {
  id        String   @id
  userId    Int
  token     String   @unique
  expiresAt DateTime
  metadata  Json?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

model Project {
  id              Int      @id @default(autoincrement())
  name            String
  slug            String   @unique
  description     String?
  ownerAddress    String?
  chainId         Int?
  createdAt       DateTime @default(now()) @map("createdAt")
  updatedAt       DateTime @updatedAt @map("updatedAt")
  contractAddress String?
  meta            Json?

  // Relations - match actual database structure
  liftTokens            LiftToken[]
  MintRequest           MintRequest[]
  Payment               Payment[]
  ProjectPaymentConfig  ProjectPaymentConfig?

  @@map("Project")
}

model LiftToken {
  id              Int     @id @default(autoincrement())
  externalId      String? @unique
  tokenId         String? @unique
  contractAddress String?
  chainId         Int?

  // Mint request relation (one-to-one)
  mintRequestId Int? @unique
  mintRequest   MintRequest? @relation(fields: [mintRequestId], references: [id])

  status   String   @default("DRAFT")
  quantity Decimal?
  unit     String?

  // Project relation
  projectId Int?
  project   Project? @relation(fields: [projectId], references: [id])

  meta      Json?
  issuedAt  DateTime?
  retiredAt DateTime?

  // Verification fields
  verificationMethodId String?
  verifiedAt           DateTime?

  // Events relation
  events LiftTokenEvent[]

  // Verification relations
  verificationResults VerificationResult[]
  verificationMethod  VerificationMethod? @relation("VerificationMethodLiftTokens", fields: [verificationMethodId], references: [methodId], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([tokenId])
  @@index([contractAddress])
  @@index([chainId])
  @@map("LiftToken")
}

model LiftTokenEvent {
  id          Int    @id @default(autoincrement())
  liftTokenId Int
  type        String

  txHash      String?
  blockNumber Int?
  logIndex    Int?

  payload Json?
  meta    Json?
  eventAt DateTime @default(now())

  liftToken LiftToken @relation(fields: [liftTokenId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([liftTokenId, type, txHash])
  @@index([liftTokenId, type])
  @@index([txHash])
  @@map("LiftTokenEvent")
}

model MintRequest {
  id           Int      @id @default(autoincrement())
  projectId    Int?
  requestHash  String   @unique
  amount       String
  recipient    String
  status       String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  project            Project?             @relation(fields: [projectId], references: [id], onDelete: Restrict)
  events             MintRequestEvent[]
  liftToken          LiftToken?

  @@map("MintRequest")
}

model MintRequestEvent {
  id            Int      @id @default(autoincrement())
  mintRequestId Int
  eventType     String
  txHash        String
  blockNumber   Int
  logIndex      Int
  createdAt     DateTime @default(now())

  mintRequest MintRequest @relation(fields: [mintRequestId], references: [id], onDelete: Cascade)

  @@map("MintRequestEvent")
}

enum MintRequestStatus {
  PENDING
  APPROVED
  MINTING
  COMPLETED
  REJECTED
  FAILED
  CANCELLED
  @@map("MintRequestStatus")
}

enum MintRequestEventType {
  SUBMITTED
  REVIEWED
  APPROVED
  REJECTED
  CANCELLED
  MINT_STARTED
  MINT_COMPLETED
  MINT_FAILED
  @@map("MintRequestEventType")
}

enum PaymentType {
  PROJECT_FUNDING
  MILESTONE_PAYMENT
  VERIFICATION_FEE
  GOVERNANCE_STAKE
  @@map("PaymentType")
}

enum PaymentStatus {
  PENDING
  CONFIRMED
  COMPLETED
  FAILED
  CANCELLED
  @@map("PaymentStatus")
}

model Payment {
  id                   String       @id
  paymentType          PaymentType
  status               PaymentStatus @default(PENDING)
  projectId            Int?
  amount               String
  paymentToken         String
  chainId              Int
  payerAddress         String
  payerEmail           String?
  recipientAddress     String
  escrowContract       String?
  escrowConfig         Json?
  txHash               String?
  blockNumber          Int?
  blockTimestamp       DateTime?
  proceedsNotified     Boolean      @default(false)
  distributionComplete Boolean      @default(false)
  description          String?
  metadata             Json?
  createdAt            DateTime     @default(now())
  updatedAt            DateTime     @updatedAt
  confirmedAt          DateTime?

  project      Project?       @relation(fields: [projectId], references: [id], onDelete: SetNull)
  events       PaymentEvent[]

  @@index([chainId])
  @@index([createdAt])
  @@index([payerAddress])
  @@index([projectId])
  @@index([status])
  @@index([txHash])
  @@map("Payment")
}

enum PaymentEventType {
  PAYMENT_INITIATED
  PAYMENT_CONFIRMED
  PAYMENT_COMPLETED
  PAYMENT_FAILED
  PAYMENT_CANCELLED
  ESCROW_DEPOSITED
  ESCROW_RELEASED
  @@map("PaymentEventType")
}

model PaymentEvent {
  id          String           @id
  paymentId   String
  type        PaymentEventType
  performedBy String?
  amount      String?
  fromAddress String?
  toAddress   String?
  txHash      String?
  blockNumber Int?
  logIndex    Int?
  gasUsed     String?
  notes       String?
  metadata    Json?
  createdAt   DateTime         @default(now())

  payment Payment @relation(fields: [paymentId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([paymentId])
  @@index([txHash])
  @@index([type])
  @@map("PaymentEvent")
}

model ProjectPaymentConfig {
  id                Int      @id @default(autoincrement())
  projectId         Int      @unique
  acceptedCurrency  String
  paymentAddress    String
  minAmount         String?
  maxAmount         String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("ProjectPaymentConfig")
}

model Contract {
  id              Int      @id @default(autoincrement())
  name            String
  address         String
  chainId         Int
  abi             Json
  deploymentTx    String?
  deployedAt      DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([address, chainId])
  @@map("Contract")
}

model IndexedEvent {
  id          Int      @id @default(autoincrement())
  eventType   String
  contractAddress String
  chainId     Int
  blockNumber Int
  txHash      String
  logIndex    Int
  eventData   Json
  createdAt   DateTime @default(now())

  @@unique([txHash, logIndex])
  @@index([contractAddress, chainId])
  @@index([blockNumber])
  @@map("IndexedEvent")
}

model IndexerState {
  id           Int      @id @default(autoincrement())
  contractAddress String
  chainId      Int
  lastBlock    Int
  updatedAt    DateTime @updatedAt

  @@unique([contractAddress, chainId])
  @@map("IndexerState")
}

enum VerificationStatus {
  PENDING
  IN_REVIEW
  VERIFIED
  REJECTED
  EXPIRED
  REVOKED
}

model VerificationMethod {
  id                Int       @id @default(autoincrement())
  methodId          String    @unique
  name              String
  description       String?
  methodologyType   String
  version           String    @default("1.0")
  criteria          Json
  requiredDataTypes Json?
  minimumConfidence Decimal?  @db.Decimal(5, 4)
  validationPeriod  Int?
  registryContract  String?
  chainId           Int?
  methodHash        String?
  active            Boolean   @default(true)
  isPublic          Boolean   @default(true)
  approvedValidators Json?
  metadata          Json?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  verificationResults VerificationResult[]
  liftTokens          LiftToken[] @relation("VerificationMethodLiftTokens")

  @@index([methodId])
  @@index([methodologyType])
  @@index([active])
  @@index([chainId])
  @@map("VerificationMethod")
}

model VerificationResult {
  id                Int                @id @default(autoincrement())
  liftTokenId       Int
  methodId          String
  verified          Boolean
  confidenceScore   Decimal?           @db.Decimal(5, 4)
  verificationLevel String?
  evidenceHash      String?
  evidenceIpfsCid   String?
  calculationData   Json?
  validatorAddress  String
  validatorName     String?
  verificationDate  DateTime
  expiryDate        DateTime?
  submittedAt       DateTime           @default(now())
  status            VerificationStatus @default(PENDING)
  notes             String?
  metadata          Json?
  reviewedBy        String?
  reviewedAt        DateTime?
  reviewNotes       String?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt

  // Relations
  liftToken          LiftToken           @relation(fields: [liftTokenId], references: [id], onDelete: Cascade)
  method            VerificationMethod @relation(fields: [methodId], references: [methodId], onDelete: Restrict)
  evidenceFiles     EvidenceFile[]

  @@index([liftTokenId])
  @@index([methodId])
  @@index([verified])
  @@index([status])
  @@index([verificationDate])
  @@index([validatorAddress])
  @@map("VerificationResult")
}

model EvidenceFile {
  id                    Int                @id @default(autoincrement())
  verificationResultId  Int
  evidenceType          String
  fileName              String
  originalFileName      String?
  fileHash              String
  ipfsCid               String?
  fileSize              BigInt
  mimeType              String?
  captureDate           DateTime?
  captureLocation       Json?
  captureDevice         String?
  uploadedBy            String
  uploadedAt            DateTime           @default(now())
  processed             Boolean            @default(false)
  processingError       String?
  verified              Boolean            @default(false)
  verifiedAt            DateTime?
  verificationHash      String?
  metadata              Json?
  createdAt             DateTime           @default(now())

  // Relations
  verificationResult    VerificationResult @relation(fields: [verificationResultId], references: [id], onDelete: Cascade)

  @@index([verificationResultId])
  @@index([evidenceType])
  @@index([fileHash])
  @@index([ipfsCid])
  @@index([uploadedBy])
  @@index([processed])
  @@map("EvidenceFile")
}